\hypertarget{modelpc_8cpp_source}{}\section{modelpc.\+cpp}
\label{modelpc_8cpp_source}\index{modelpc.\+cpp@{modelpc.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include "\hyperlink{modelpc_8h}{modelpc.h}"}
00002 \textcolor{preprocessor}{#include <QDebug>}
00003 \textcolor{preprocessor}{#include <QtMath>}
\hypertarget{modelpc_8cpp_source.tex_l00009}{}\hyperlink{class_model_p_c_ae12ebe65ec973c02a0de4850a7c1e31c}{00009} \hyperlink{class_model_p_c_ae12ebe65ec973c02a0de4850a7c1e31c}{ModelPC::ModelPC}()
00010 \{
00011     \textcolor{comment}{// Version control}
00012     \hyperlink{class_model_p_c_a5f426725ccf7eefd3c77ea8c720264c9}{versionString} = \textcolor{stringliteral}{"1.4.2"};
00013 
00014     \textcolor{keyword}{auto} ver = \hyperlink{class_model_p_c_a5f426725ccf7eefd3c77ea8c720264c9}{versionString}.split(\textcolor{stringliteral}{"."});
00015     \hyperlink{class_model_p_c_a5af48ab89e19be42a94c34ba00249401}{version} = ver[0].toInt() * qPow(2, 16) + ver[1].toInt() * qPow(2, 8) + ver[2].toInt();
00016 
00017     ver\_byte = bytes(ver[0].toInt()) +
00018             bytes(ver[1].toInt()) +
00019             bytes(ver[2].toInt());
00020     \textcolor{comment}{// Random seed}
00021     qsrand(randSeed());
00022 \}
00023 
\hypertarget{modelpc_8cpp_source.tex_l00024}{}\hyperlink{class_model_p_c_aad427b77cf44b5dadc5523ea03272c85}{00024} QImage *\hyperlink{class_model_p_c_aad427b77cf44b5dadc5523ea03272c85}{ModelPC::Encrypt}(QByteArray data, QImage *image, 
      \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode} \_mode, QString key, \textcolor{keywordtype}{int} \_bitsUsed, QString *\_error)
00025 \{
00026     \textcolor{keywordflow}{return} \hyperlink{class_model_p_c_ae12ebe65ec973c02a0de4850a7c1e31c}{ModelPC}().encrypt(data, image, \_mode, key, \_bitsUsed, \_error);
00027 \}
00028 
\hypertarget{modelpc_8cpp_source.tex_l00029}{}\hyperlink{class_model_p_c_a11c3709b87ca83bce474d377f35660ac}{00029} QImage *\hyperlink{class_model_p_c_a11c3709b87ca83bce474d377f35660ac}{ModelPC::Inject}(QByteArray encr\_data, QImage *image, 
      \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode} \_mode, \textcolor{keywordtype}{int} \_bitsUsed, QString *\_error)
00030 \{
00031     \textcolor{keywordflow}{return} \hyperlink{class_model_p_c_ae12ebe65ec973c02a0de4850a7c1e31c}{ModelPC}().inject(encr\_data, image, \_mode, \_bitsUsed, \_error);
00032 \}
00033 
\hypertarget{modelpc_8cpp_source.tex_l00034}{}\hyperlink{class_model_p_c_afbca3c9c9b7d92f3a5cc81510ef06cc3}{00034} QByteArray \hyperlink{class_model_p_c_afbca3c9c9b7d92f3a5cc81510ef06cc3}{ModelPC::Decrypt}(QImage *image, QString key, 
      \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode} \_mode, QString *\_error)
00035 \{
00036     \textcolor{keywordflow}{return} \hyperlink{class_model_p_c_ae12ebe65ec973c02a0de4850a7c1e31c}{ModelPC}().decrypt(image, key, \_mode, \_error);
00037 \}
\hypertarget{modelpc_8cpp_source.tex_l00051}{}\hyperlink{class_model_p_c_a6f191f62d4635d0d3555fcc0be298794}{00051} QImage * \hyperlink{class_model_p_c_a6f191f62d4635d0d3555fcc0be298794}{ModelPC::encrypt}(QByteArray data, QImage * image, \textcolor{keywordtype}{int} \_mode, QString key, \textcolor{keywordtype}{int} 
      \_bitsUsed, QString *\_error)
00052 \{
00053     \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00054     \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode} mode = \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode}(\_mode);
00055     \textcolor{comment}{// Error management}
00056     \textcolor{keywordflow}{if}(\_error == \textcolor{keyword}{nullptr})
00057         \_error = \textcolor{keyword}{new} QString();
00058     *\_error = \textcolor{stringliteral}{"ok"};
00059     \hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error} = \_error;
00060 
00061     \textcolor{keywordflow}{if}(data == \textcolor{keyword}{nullptr} || data.isEmpty()) \{
00062         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"nodata"});
00063         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00064     \}
00065     \textcolor{keywordflow}{if}(data.size() > pow(2, 24)) \{
00066         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"muchdata"});
00067         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00068     \}
00069     \textcolor{keywordflow}{if}(image == \textcolor{keyword}{nullptr} || image->isNull()) \{
00070         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"nullimage"});
00071         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00072     \}
00073     \textcolor{keywordflow}{if}(image->width() * image->height() > pow(10, 9)) \{
00074         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bigimage"});
00075         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00076     \}
00077     \textcolor{keywordflow}{if}(\_bitsUsed < 1 || \_bitsUsed > 8) \{
00078         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bitsWrong"});
00079         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00080     \}
00081     \textcolor{keywordflow}{if}(key == \textcolor{keyword}{nullptr} || key.isEmpty()) \{
00082         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"no\_key"});
00083         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00084     \}
00085     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(key.size() > 255) \{
00086         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bigkey"});
00087         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00088     \}
00089     \textcolor{keywordflow}{if}(mode == CryptMode::Unspecified) \{
00090         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"undefined\_mode"});
00091         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00092     \}
00093     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} usedBytes = data.size() + 14 + key.size();
00094     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} size = image->width() * image->height();
00095     \textcolor{keywordflow}{if}(usedBytes * 100 / (size * 3) * 8 / \_bitsUsed > 70) \{
00096         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bigdata"});
00097         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00098     \}
00099 
00100     \textcolor{keywordflow}{switch}(mode)
00101     \{
00102         \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba7612e38de7178170655a56ddcf96e12c}{v1\_3}:
00103         \{
00104             QByteArray zipped\_data = \hyperlink{class_model_p_c_afebbbfa4b07deba4f68fc6dfb50f353f}{zip}(data, key.toUtf8());
00105             QByteArray hash = QCryptographicHash::hash(data, QCryptographicHash::Sha256);
00106             QByteArray encr\_data = hash + zipped\_data;
00107             \textcolor{keywordflow}{if}(*\hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error} == \textcolor{stringliteral}{"ok"})
00108                 \textcolor{keywordflow}{return} \hyperlink{class_model_p_c_aada6a04d81ada8f2b4ba18108c8d6f10}{inject}(encr\_data, image, \_mode, \_bitsUsed, \hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error});
00109             \textcolor{keywordflow}{else}
00110                 \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00111             \textcolor{keywordflow}{break};
00112         \}
00113         \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba43138df6b33a6b2bf608768907f95abc}{v1\_4}:
00114             bitsUsed = \_bitsUsed;
00115             \hyperlink{class_model_p_c_a4daefc3fb87a1f19172b9b20c987eb12}{encryptv1\_4}(image, data, key);
00116             emit \hyperlink{class_model_p_c_a41f5e2e8022679046e4d3fa1109025fa}{saveImage}(image);
00117             \textcolor{keywordflow}{return} image;
00118         \textcolor{keywordflow}{break};
00119         \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba90ca32d3ccbb6be224cdfc33f7096eea}{jphs\_mode}:
00120             \textcolor{comment}{// TODO add jphs}
00121             \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00122         \textcolor{keywordflow}{break};
00123         \textcolor{keywordflow}{default}:
00124             \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"wrongmode"});
00125             \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00126     \}
00127 \}
00128 
\hypertarget{modelpc_8cpp_source.tex_l00139}{}\hyperlink{class_model_p_c_aada6a04d81ada8f2b4ba18108c8d6f10}{00139} QImage * \hyperlink{class_model_p_c_aada6a04d81ada8f2b4ba18108c8d6f10}{ModelPC::inject}(QByteArray encr\_data, QImage * image, \textcolor{keywordtype}{int} \_mode, \textcolor{keywordtype}{int} \_bitsUsed, 
      QString *\_error)
00140 \{
00141     \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00142     \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode} mode = \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode}(\_mode);
00143     \textcolor{comment}{// Error management}
00144     \textcolor{keywordflow}{if}(\_error == \textcolor{keyword}{nullptr})
00145         \_error = \textcolor{keyword}{new} QString();
00146     *\_error = \textcolor{stringliteral}{"ok"};
00147     \hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error} = \_error;
00148 
00149     bitsUsed = \_bitsUsed;
00150 
00151     \textcolor{keywordflow}{if}(encr\_data == \textcolor{keyword}{nullptr} || encr\_data.isEmpty()) \{
00152         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"nodata"});
00153         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00154     \}
00155     \textcolor{keywordflow}{if}(encr\_data.size() > pow(2, 24)) \{
00156         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"muchdata"});
00157         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00158     \}
00159     \textcolor{keywordflow}{if}(image == \textcolor{keyword}{nullptr} || image->isNull()) \{
00160         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"nullimage"});
00161         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00162     \}
00163     \textcolor{keywordflow}{if}(image->width() * image->height() > pow(10, 9)) \{
00164         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bigimage"});
00165         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00166     \}
00167     \textcolor{keywordflow}{if}(\_bitsUsed < 1 || \_bitsUsed > 8) \{
00168         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bitsWrong"});
00169         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00170     \}
00171     \textcolor{keywordflow}{if}(mode == CryptMode::Unspecified) \{
00172         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"undefined\_mode"});
00173         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00174     \}
00175 
00176     encr\_data = ver\_byte + encr\_data;
00177     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} countBytes = encr\_data.size();
00178     \textcolor{keywordflow}{switch}(mode)
00179     \{
00180     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba7612e38de7178170655a56ddcf96e12c}{v1\_3}:
00181         \hyperlink{class_model_p_c_a1d0091062a0c836b283ec2f67411623b}{circuit}(image, &encr\_data, countBytes);
00182         \textcolor{keywordflow}{break};
00183     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba90ca32d3ccbb6be224cdfc33f7096eea}{jphs\_mode}:
00184         \hyperlink{class_model_p_c_a8bee0255c09449868c7e6097afaaf0cd}{jphs}(image, &encr\_data);
00185         \textcolor{keywordflow}{break};
00186     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba43138df6b33a6b2bf608768907f95abc}{v1\_4}:
00187         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"inject-v1.4"});
00188         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00189         \textcolor{keywordflow}{break};
00190     \textcolor{keywordflow}{default}:
00191         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"wrongmode"});
00192         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00193     \}
00194 
00195     \textcolor{comment}{// Saving}
00196     \textcolor{keywordflow}{if}(\hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success}) \{
00197         emit \hyperlink{class_model_p_c_a41f5e2e8022679046e4d3fa1109025fa}{saveImage}(image);
00198         \textcolor{keywordflow}{return} image;
00199     \}
00200     \textcolor{keywordflow}{else}
00201         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00202 \}
\hypertarget{modelpc_8cpp_source.tex_l00212}{}\hyperlink{class_model_p_c_a69ea58f4455f8536c4be1d3f44424a60}{00212} QByteArray \hyperlink{class_model_p_c_a69ea58f4455f8536c4be1d3f44424a60}{ModelPC::decrypt}(QImage * image, QString key, \textcolor{keywordtype}{int} \_mode, QString *\_error)
00213 \{
00214     \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00215     \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode} mode = \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceb}{CryptMode}(\_mode);
00216     \textcolor{comment}{// Error management}
00217     \textcolor{keywordflow}{if}(\_error == \textcolor{keyword}{nullptr})
00218         \_error = \textcolor{keyword}{new} QString();
00219     *\_error = \textcolor{stringliteral}{"ok"};
00220     \hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error} = \_error;
00221     \textcolor{keywordflow}{if}(image == \textcolor{keyword}{nullptr} || image->isNull()) \{
00222         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"nullimage"});
00223         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00224     \}
00225     \textcolor{keywordflow}{if}(image->width() * image->height() > pow(10, 9)) \{
00226         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bigimage"});
00227         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00228     \}
00229     \textcolor{keywordflow}{if}(key == \textcolor{keyword}{nullptr} || key.isEmpty()) \{
00230         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"no\_key"});
00231         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00232     \}
00233     QByteArray result;
00234 
00235     \textcolor{keywordflow}{switch} (mode) \{
00236     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba7612e38de7178170655a56ddcf96e12c}{v1\_3}:
00237         result = \hyperlink{class_model_p_c_a4fe70ebbedfaf31d45a35f82d0f06caa}{decryptv1\_3}(image, key);
00238     \textcolor{keywordflow}{break};
00239     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba43138df6b33a6b2bf608768907f95abc}{v1\_4}:
00240         result = \hyperlink{class_model_p_c_a7a1f7d491e1bde16936190b9e90896b0}{decryptv1\_4}(image, key);
00241     \textcolor{keywordflow}{break};
00242     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba90ca32d3ccbb6be224cdfc33f7096eea}{jphs\_mode}:
00243         \textcolor{comment}{// TODO add jphs support}
00244     \textcolor{keywordflow}{break};
00245     \textcolor{keywordflow}{case} \hyperlink{class_model_p_c_a296dd7afe3e1c49b3da25fd644fe4ceba56028870bb6c96c44e7ba33b82d39598}{Unspecified}:
00246         isTry = \textcolor{keyword}{true};
00247 
00248         \textcolor{comment}{// v1\_3}
00249         result = \hyperlink{class_model_p_c_a4fe70ebbedfaf31d45a35f82d0f06caa}{decryptv1\_3}(\textcolor{keyword}{new} QImage(*image), key);
00250         \textcolor{keywordflow}{if}(\hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success}) \{
00251             isTry = \textcolor{keyword}{false};
00252             \textcolor{keywordflow}{break};
00253         \}
00254         \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00255 
00256         \textcolor{comment}{// v1\_4}
00257         result = \hyperlink{class_model_p_c_a7a1f7d491e1bde16936190b9e90896b0}{decryptv1\_4}(image, key);
00258         \textcolor{keywordflow}{if}(\hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success}) \{
00259             isTry = \textcolor{keyword}{false};
00260             \textcolor{keywordflow}{break};
00261         \}
00262         \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00263 
00264         \textcolor{comment}{// TODO add jphs support}
00265 
00266         isTry = \textcolor{keyword}{false};
00267         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"all\_modes\_fail"});
00268         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00269     \textcolor{keywordflow}{break};
00270     \textcolor{keywordflow}{default}:
00271         \textcolor{comment}{// For invalid modes}
00272         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"wrongmode"});
00273         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00274     \}
00275     \textcolor{keywordflow}{if}(*\hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error} == \textcolor{stringliteral}{"ok"})
00276         emit \hyperlink{class_model_p_c_a0855107fb0ccc247cd9e893fae9bb08a}{saveData}(result);
00277     \textcolor{keywordflow}{return} result;
00278 \}
\hypertarget{modelpc_8cpp_source.tex_l00283}{}\hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{00283} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{ModelPC::fail}(QString message)
00284 \{
00285     \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{false};
00286     \textcolor{keywordflow}{if}(!isTry) \{
00287         *\hyperlink{class_model_p_c_a4e5a9c0ca1f06fe5bc478b6bf248c37c}{error} = message;
00288         \hyperlink{class_model_p_c_a9079a101d83672aa48fd2dbac797de40}{alert}(message, \textcolor{keyword}{true});
00289         emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(101);
00290         qDebug() << \textcolor{stringliteral}{"[Debug] !!! fail() - "} << message;
00291     \}
00292 \}
\hypertarget{modelpc_8cpp_source.tex_l00298}{}\hyperlink{class_model_p_c_a8bee0255c09449868c7e6097afaaf0cd}{00298} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a8bee0255c09449868c7e6097afaaf0cd}{ModelPC::jphs}(QImage *image, QByteArray *data)
00299 \{
00300     \textcolor{comment}{// Under Development}
00301     \textcolor{keywordflow}{return};
00302 
00303     \textcolor{comment}{// Dead code}
00304 
00305     \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00306     \textcolor{keywordtype}{bool} isEncrypt = !data->isEmpty();
00307     QString targetEXE = \hyperlink{class_model_p_c_abd038306f14f22fb885a1697c96d6335}{defaultJPHSDir} + (isEncrypt ? \textcolor{stringliteral}{"/jphide.exe"} : \textcolor{stringliteral}{"/jpseek.exe"});
00308     \textcolor{keywordflow}{if}(!fileExists(targetEXE))
00309     \{
00310         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"nojphs"});
00311         \textcolor{keywordflow}{return};
00312     \}
00313 
00314     QString randomFileName = \hyperlink{class_model_p_c_abd038306f14f22fb885a1697c96d6335}{defaultJPHSDir} + \textcolor{stringliteral}{"/"};
00315     qsrand(randSeed());
00316     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 10; i++)
00317         randomFileName.append(97 + qrand() % 25);
00318     image->save(randomFileName + \textcolor{stringliteral}{".jpg"});
00319     \textcolor{keywordflow}{if}(isEncrypt) \{
00320         QFile file(randomFileName + \textcolor{stringliteral}{".pc"});
00321         \textcolor{keywordflow}{if}(!file.open(QFile::WriteOnly)) \{
00322             \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"save\_file\_fail"});
00323             \textcolor{keywordflow}{return};
00324         \}
00325         file.write(*data);
00326         file.close();
00327 
00328         QStringList args;
00329         args << (randomFileName + \textcolor{stringliteral}{".jpg"}) << (randomFileName + \textcolor{stringliteral}{"\_out.jpg"}) << (randomFileName + \textcolor{stringliteral}{".pc"});
00330         QProcess prog(\textcolor{keyword}{this});
00331         prog.start(targetEXE, args);
00332         prog.waitForStarted();
00333         prog.write(\textcolor{stringliteral}{"test\(\backslash\)n"});
00334         prog.waitForBytesWritten();
00335         prog.write(\textcolor{stringliteral}{"test\(\backslash\)n"});
00336         prog.waitForBytesWritten();
00337         prog.waitForReadyRead();
00338         QByteArray bytes = prog.readAll();
00339         prog.waitForFinished();
00340         \textcolor{comment}{//QByteArray readData = prog.readAll();}
00341         prog.close();
00342         \textcolor{comment}{// Cleaning - Deleting temp files}
00343 
00344     \}
00345     \textcolor{keywordflow}{else} \{
00346 
00347     \}
00348 
00349 \}
00350 
\hypertarget{modelpc_8cpp_source.tex_l00359}{}\hyperlink{class_model_p_c_a1d0091062a0c836b283ec2f67411623b}{00359} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a1d0091062a0c836b283ec2f67411623b}{ModelPC::circuit}(QImage *image, QByteArray *data, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} countBytes)
00360 \{
00361     \textcolor{comment}{// Some flags and creation of the ProgressDialog}
00362     \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} = \textcolor{keyword}{true};
00363     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(-1);
00364     \textcolor{keywordtype}{bool} isEncrypt = !data->isEmpty();
00365 
00366     \textcolor{comment}{// Image setup}
00367     \textcolor{keywordtype}{int} w = image->width();
00368     \textcolor{keywordtype}{int} h = image->height();
00369 
00370     \textcolor{comment}{// Visited pixels array}
00371     QVector <QPoint> were;
00372     were.push\_back(QPoint(0, 0));
00373     were.push\_back(QPoint(0, h - 1));
00374     were.push\_back(QPoint(w - 1, 0));
00375     were.push\_back(QPoint(w - 1, h - 1));
00376 
00377     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} offset = 0;
00378 
00379     \textcolor{comment}{// Pre-start Cleaning}
00380     circuitData = data;
00381     circuitImage = image;
00382     circuitCountBytes = countBytes;
00383     cur = 0;
00384     bitsBuffer.clear();
00385 
00386     \textcolor{comment}{// Writing Top-Left to Bottom-Left}
00387     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 1; i < h - 1 && mustGoOn(isEncrypt); i++) \{
00388         QPoint pos(0, i);
00389         \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{processPixel}(pos, &were, isEncrypt);
00390     \}
00391     \textcolor{comment}{// Writing Bottom-Right to Top-Right}
00392     \textcolor{keywordflow}{if}(mustGoOn(isEncrypt))
00393     \{
00394         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = h - 2; i >= 1 && mustGoOn(isEncrypt); i--)\{
00395             QPoint pos(w - 1, i);
00396             \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{processPixel}(pos, &were, isEncrypt);
00397         \}
00398     \}
00399     \textcolor{comment}{// Main cycle}
00400     \textcolor{comment}{// Strong is considered as actual corner pixel and weak as pixel near it like (1, 0) or (0, 1)}
00401     \textcolor{keywordflow}{while}(mustGoOn(isEncrypt))
00402     \{
00403         \textcolor{comment}{// Strong Top-Right to Strong Bottom-Right}
00404         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = offset; i < h - offset && mustGoOn(isEncrypt); i++)\{
00405             QPoint pos(w - offset - 2, i);
00406             \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{processPixel}(pos, &were, isEncrypt);
00407         \}
00408         \textcolor{comment}{// Strong Top-Left to Weak Top-Right}
00409         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = offset + 1; i < w - offset - 2 && mustGoOn(isEncrypt); i++)\{
00410             QPoint pos(i, offset);
00411             \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{processPixel}(pos, &were, isEncrypt);
00412         \}
00413         \textcolor{comment}{// Weak Bottom-Right to Weak Bottom-Left}
00414         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = w - 3 - offset; i >= offset + 2 && mustGoOn(isEncrypt); i--)\{
00415             QPoint pos(i, h - offset - 1);
00416             \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{processPixel}(pos, &were, isEncrypt);
00417         \}
00418         \textcolor{comment}{// Weak Top-Left to Strong Bottom-Left}
00419         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = offset + 1; i < h - offset && mustGoOn(isEncrypt); i++)\{
00420             QPoint pos(offset + 1, i);
00421             \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{processPixel}(pos, &were, isEncrypt);
00422         \}
00423         offset++;
00424     \}
00425     \textcolor{comment}{// Extra writing}
00426     \textcolor{keywordflow}{if}(!\hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success})
00427         \textcolor{keywordflow}{return};
00428     \textcolor{keywordflow}{if}(isEncrypt)
00429     \{
00430         \textcolor{comment}{// Getting past colors}
00431         QColor colUL = image->pixelColor(0, 0).toRgb();
00432         QColor colUR = image->pixelColor(w - 1, 0).toRgb();
00433         QColor colDL = image->pixelColor(0, h - 1).toRgb();
00434         QColor colDR = image->pixelColor(w - 1, h - 1).toRgb();
00435         \textcolor{keywordtype}{int} red = 0;
00436         \textcolor{keywordtype}{int} green = 0;
00437         \textcolor{keywordtype}{int} blue = 0;
00438 
00439         \textcolor{comment}{// Writing Upper Left}
00440         red = (colUL.red() & 224) + (countBytes >> 19);
00441         green = (colUL.green() & 224) + (countBytes >> 14) % 32;
00442         blue = (colUL.blue() & 224) + (countBytes >> 9) % 32;
00443         image->setPixelColor(0, 0, QColor(red, green, blue));
00444 
00445         \textcolor{comment}{// Writing Upper Right}
00446         red = (colUR.red() & 224) + (countBytes >> 4) % 32;
00447         green = (colUR.green() & 224) + ((countBytes % 16) << 1) + 1;
00448         blue = (colUR.blue() & 224) + 9;
00449         image->setPixelColor(w - 1, 0, QColor(red, green, blue));
00450 
00451         \textcolor{comment}{// Getting extra bytes if left}
00452         \textcolor{keywordflow}{while}(cur < countBytes)
00453             push(mod(circuitData->at(cur++)), 8);
00454         \textcolor{keywordflow}{if}(bitsBuffer.size() > 20) \{
00455             \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bitsBufferFail"});
00456             \textcolor{keywordflow}{return};
00457         \}
00458         \textcolor{comment}{// Getting extra data as long.}
00459         \textcolor{keywordtype}{long} extraData = pop(-2);
00460 
00461         \textcolor{comment}{// Writing Down Left}
00462         red = (colDL.red() & 224) + (extraData >> 15);
00463         green = (colDL.green() & 224) + (extraData >> 10) % 32;
00464         blue = (colDL.blue() & 224) + (extraData >> 5) % 32;
00465         image->setPixelColor(0, h - 1, QColor(red, green, blue));
00466 
00467         \textcolor{comment}{// Writing Down Right}
00468         red = (colDR.red() & 224) + extraData % 32;
00469         green = (colDR.green() & 224);
00470         blue = (colDR.blue() & 224) + ((bitsUsed - 1) << 2) + 2;
00471         image->setPixelColor(w - 1, h - 1, QColor(red, green, blue));
00472     \}
00473     \textcolor{keywordflow}{else}
00474     \{
00475         \textcolor{comment}{// Read the past pixels}
00476         QColor colDL = image->pixelColor(0, h - 1).toRgb();
00477         QColor colDR = image->pixelColor(w - 1, h - 1).toRgb();
00478 
00479         \textcolor{comment}{// Read extra data}
00480         \textcolor{keywordtype}{long} extraData = ((colDL.red() % 32) << 15) + ((colDL.green() % 32) << 10);
00481         extraData += ((colDL.blue() % 32) << 5) + colDR.red() % 32;
00482 
00483         \textcolor{comment}{// Add extra data to the bitsBuffer}
00484         push(extraData, (countBytes - cur) * 8 - bitsBuffer.size());
00485 
00486         \textcolor{comment}{// Move bits from bitsBuffer to the QByteArray}
00487         \textcolor{keywordflow}{while}(!bitsBuffer.isEmpty())
00488             data->append(pop(8));
00489     \}
00490     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(101);
00491 \}
00492 
\hypertarget{modelpc_8cpp_source.tex_l00500}{}\hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{00500} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a1171f9fe1550133dc9053a46b4e5bcfd}{ModelPC::processPixel}(QPoint pos, QVector<QPoint> *were, \textcolor{keywordtype}{bool} isEncrypt)
00501 \{
00502     \textcolor{keywordflow}{if}(!\hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success})
00503         \textcolor{keywordflow}{return};
00504     \textcolor{comment}{// Check if point was already visited}
00505     \textcolor{keywordflow}{if}(were->contains(pos))\{
00506         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"point\_visited\_twice"});
00507         \textcolor{keywordflow}{return};
00508     \}
00509     \textcolor{keywordflow}{else}
00510         were->push\_back(pos);
00511     \textcolor{keywordflow}{if}(isEncrypt)
00512     \{
00513         \textcolor{comment}{// Make sure that there are enough bits in bitsBuffer to write}
00514         \textcolor{keywordflow}{while}(bitsBuffer.size() < 3 * bitsUsed)
00515             push(mod(circuitData->at(cur++)), 8);
00516         \textcolor{comment}{// Read past contains}
00517         QColor pixelColor = circuitImage->pixelColor(pos);
00518         \textcolor{keywordtype}{int} red = pixelColor.red();
00519         \textcolor{keywordtype}{int} green = pixelColor.green();
00520         \textcolor{keywordtype}{int} blue = pixelColor.blue();
00521 
00522         \textcolor{comment}{// Write new data in last bitsUsed pixels}
00523         red += pop() - red % (int) qPow(2, bitsUsed);
00524         green += pop() - green % (int) qPow(2, bitsUsed);
00525         blue += pop() - blue % (int) qPow(2, bitsUsed);
00526 
00527         circuitImage->setPixelColor(pos, QColor(red, green, blue));
00528     \}
00529     \textcolor{keywordflow}{else}
00530     \{
00531         QColor read\_color = circuitImage->pixelColor(pos).toRgb();
00532         \textcolor{comment}{// Reading the pixel}
00533         \textcolor{keywordtype}{int} red = read\_color.red();
00534         \textcolor{keywordtype}{int} green = read\_color.green();
00535         \textcolor{keywordtype}{int} blue = read\_color.blue();
00536 
00537         \textcolor{comment}{// Reading the last bitsUsed pixels}
00538         red %= (int) qPow(2, bitsUsed);
00539         green %= (int) qPow(2, bitsUsed);
00540         blue %= (int) qPow(2, bitsUsed);
00541 
00542         \textcolor{comment}{// Getting the data in the bitsBuffer.}
00543         push(red);
00544         push(green);
00545         push(blue);
00546 
00547         \textcolor{comment}{// Getting data to QByteArray}
00548         \textcolor{keywordflow}{while}(bitsBuffer.size() >= 8) \{
00549             circuitData->append(pop(8));
00550             cur++;
00551         \}
00552     \}
00553     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(100 * cur / circuitCountBytes);
00554 \}
\hypertarget{modelpc_8cpp_source.tex_l00561}{}\hyperlink{class_model_p_c_a4daefc3fb87a1f19172b9b20c987eb12}{00561} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a4daefc3fb87a1f19172b9b20c987eb12}{ModelPC::encryptv1\_4}(QImage *image, QByteArray data, QString key)
00562 \{
00563     \textcolor{keywordflow}{if}(data.size() + 98 > image->height() * image->width() * 3) \{
00564         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"bigdata"});
00565         \textcolor{keywordflow}{return};
00566     \}
00567     QTime st = QTime::currentTime();
00568     QByteArray rand\_master = GetRandomBytes(32);
00569     QByteArray pass = QCryptographicHash::hash(key.toUtf8() + rand\_master + QByteArray(\textcolor{stringliteral}{"hi"}), 
      QCryptographicHash::Sha3\_384);
00570     QByteArray noise = GetRandomBytes(data.size() / 10 + 32);
00571     QByteArray bytes\_key = GetRandomBytes(32);
00572     QByteArray pass\_rand = QCryptographicHash::hash(pass + bytes\_key, QCryptographicHash::Sha3\_512);
00573     QByteArray zipped = \hyperlink{class_model_p_c_afebbbfa4b07deba4f68fc6dfb50f353f}{zip}(data, pass\_rand);
00574     QByteArray heavy\_data = zipped + noise;
00575 
00576     QByteArray verification = QCryptographicHash::hash(pass + bytes\_key, QCryptographicHash::Sha3\_256);
00577     QByteArray given\_key = bytes\_key.left(30);
00578     QByteArray heavy\_data\_size;
00579     \textcolor{comment}{// heavy\_data\_size is always 4 bytes as max for heavy\_data is: 2^24 * 11/10 + 32 ~ 1.8 * 10^7 < 2^32}
00580     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} raw\_size = zipped.size();
00581     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 4; i++) \{
00582         \textcolor{keywordtype}{int} ch = raw\_size % 256;
00583         raw\_size >>= 8;
00584         heavy\_data\_size.push\_front(ch);
00585     \}
00586     QByteArray mid\_data = verification + given\_key + rand\_master + heavy\_data\_size;
00587     \textcolor{comment}{// mid\_data.size() = 32 + 30 + 32 + 4 = 98}
00588     QVector <QPair<QPoint, QPair<int, int>>> *were = \textcolor{keyword}{new} QVector <QPair<QPoint, QPair<int, int>>>();
00589     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(-1);
00590     \hyperlink{class_model_p_c_a5cdb4d1d61ff62ee9d45b496a7dbf1fb}{proccessPixelsv1\_4}(image, &mid\_data, key.toUtf8(), \textcolor{keyword}{true}, were);
00591     \hyperlink{class_model_p_c_a5cdb4d1d61ff62ee9d45b496a7dbf1fb}{proccessPixelsv1\_4}(image, &heavy\_data, pass\_rand, \textcolor{keyword}{true}, were);
00592     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(101);
00593     QTime \textcolor{keyword}{final} = QTime::currentTime();
00594     qDebug() << \textcolor{stringliteral}{"[Debug] Finished encrypting in "} << st.msecsTo(\textcolor{keyword}{final}) << \textcolor{stringliteral}{" msecs."};
00595 \}
00596 
\hypertarget{modelpc_8cpp_source.tex_l00603}{}\hyperlink{class_model_p_c_a7a1f7d491e1bde16936190b9e90896b0}{00603} QByteArray \hyperlink{class_model_p_c_a7a1f7d491e1bde16936190b9e90896b0}{ModelPC::decryptv1\_4}(QImage *image, QString key)
00604 \{
00605     QTime st = QTime::currentTime();
00606     QByteArray mid\_data, heavy\_data;
00607     QVector <QPair<QPoint, QPair<int, int>>> *were = \textcolor{keyword}{new} QVector <QPair<QPoint, QPair<int, int>>>();
00608     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(-1);
00609     \hyperlink{class_model_p_c_a5cdb4d1d61ff62ee9d45b496a7dbf1fb}{proccessPixelsv1\_4}(image, &mid\_data, key.toUtf8(), \textcolor{keyword}{false}, were, 98);
00610     QByteArray verification = mid\_data.left(32);
00611     QByteArray given\_key = mid\_data.mid(32, 30);
00612     QByteArray rand\_master = mid\_data.mid(62, 32);
00613     QByteArray heavy\_data\_size = mid\_data.right(4);
00614 
00615     QByteArray pass = QCryptographicHash::hash(key.toUtf8() + rand\_master + QByteArray(\textcolor{stringliteral}{"hi"}), 
      QCryptographicHash::Sha3\_384);
00616 
00617     \textcolor{comment}{// Guessing}
00618     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(0);
00619     QByteArray bytes\_key;
00620     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long} i = 0; i < pow(2, 16); i++) \{
00621         QByteArray guess\_part;
00622         \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} g = i;
00623         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} q = 0; q < 2; q++) \{
00624                 \textcolor{keywordtype}{int} ch = g % 256;
00625                 g >>= 8;
00626                 guess\_part.push\_front(ch);
00627             \}
00628         emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(100 * i / pow(2, 16));
00629         QByteArray guess = given\_key + guess\_part;
00630         QByteArray check = QCryptographicHash::hash(pass + guess, QCryptographicHash::Sha3\_256);
00631         \textcolor{keywordflow}{if}(check == verification) \{
00632             bytes\_key = guess;
00633             \textcolor{keywordflow}{break};
00634         \}
00635     \}
00636     \textcolor{keywordflow}{if}(bytes\_key.isEmpty()) \{
00637         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"veriffail"});
00638         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00639     \}
00640 
00641     QByteArray pass\_rand = QCryptographicHash::hash(pass + bytes\_key, QCryptographicHash::Sha3\_512);
00642 
00643     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} raw\_size = mod(heavy\_data\_size[3]) +
00644             mod(heavy\_data\_size[2]) * pow(2, 8) +
00645             mod(heavy\_data\_size[1]) * pow(2, 16) +
00646             mod(heavy\_data\_size[0]) * pow(2, 24);
00647     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(0);
00648     \hyperlink{class_model_p_c_a5cdb4d1d61ff62ee9d45b496a7dbf1fb}{proccessPixelsv1\_4}(image, &heavy\_data, pass\_rand, \textcolor{keyword}{false}, were, raw\_size);
00649     QByteArray unzipped = \hyperlink{class_model_p_c_a6da88f166785a49f73b22c169f956fd0}{unzip}(heavy\_data, pass\_rand);
00650     emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(101);
00651     QTime \textcolor{keyword}{final} = QTime::currentTime();
00652     qDebug() << \textcolor{stringliteral}{"[Debug] Finished decrypting in "} << st.msecsTo(\textcolor{keyword}{final}) << \textcolor{stringliteral}{" msecs."};
00653     \textcolor{keywordflow}{return} unzipped;
00654 \}
\hypertarget{modelpc_8cpp_source.tex_l00664}{}\hyperlink{class_model_p_c_a5cdb4d1d61ff62ee9d45b496a7dbf1fb}{00664} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a5cdb4d1d61ff62ee9d45b496a7dbf1fb}{ModelPC::proccessPixelsv1\_4}(QImage *image, QByteArray* data, QByteArray key
      , \textcolor{keywordtype}{bool} isEncrypt, QVector <QPair<QPoint, QPair<int, int>>> *were, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} size)
00665 \{
00666     \textcolor{keywordtype}{long} w = image->width();
00667     \textcolor{keywordtype}{long} h = image->height();
00668     \textcolor{keyword}{auto} seed\_hex = QCryptographicHash::hash(key, QCryptographicHash::Sha3\_256).toHex().left(8).toUpper();
00669     \textcolor{keyword}{auto} seed = seed\_hex.toLongLong(\textcolor{keyword}{nullptr}, 16);
00670     QRandomGenerator foo(seed);
00671 
00672     bitsBuffer.clear();
00673     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} left = (size == -1 ? data->size() : size) * 8;
00674     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} all = left;
00675     \textcolor{keywordtype}{long} cur = 0;
00676     \textcolor{keywordflow}{if}(isEncrypt) \{
00677         \textcolor{keywordflow}{while}(left > 0 && \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success})
00678         \{
00679             \textcolor{keywordflow}{if}(bitsBuffer.empty())
00680                 push(mod(data->at(cur++)), 8);
00681             quint64 g = foo.generate64() % (w * h);
00682             \textcolor{keywordtype}{long} x = g % w;
00683             \textcolor{keywordtype}{long} y = g / w;
00684             \textcolor{keywordtype}{int} c = foo.generate64() % 3;
00685             \textcolor{keywordtype}{int} b = foo.generate64() % 24;
00686             \textcolor{keywordtype}{int} bit = -1;
00687             \textcolor{keywordflow}{if}(b < 16)
00688                 bit = 7;
00689             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 20)
00690                 bit = 6;
00691             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 22)
00692                 bit = 5;
00693             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 23)
00694                 bit = 4;
00695             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 24)
00696                 bit = 3;
00697             \textcolor{keyword}{auto} piece = qMakePair(QPoint(x, y), qMakePair(c, bit));
00698             \textcolor{keywordflow}{if}(were->contains(piece))
00699                 \textcolor{keywordflow}{continue};
00700             were->append(piece);
00701             left--;
00702             emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(100 * (all - left) / all);
00703             \textcolor{keywordtype}{int} wr = pop(1);
00704             QColor pixel = image->pixelColor(piece.first);
00705             \textcolor{keywordtype}{int} red = pixel.red();
00706             \textcolor{keywordtype}{int} green = pixel.green();
00707             \textcolor{keywordtype}{int} blue = pixel.blue();
00708             \textcolor{keywordtype}{int} dif;
00709             \textcolor{keywordflow}{if}(c == 0)
00710                 dif = red;
00711             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (c == 1)
00712                 dif = green;
00713             \textcolor{keywordflow}{else}
00714                 dif = blue;
00715             dif |= 1 << (7 - bit);
00716             dif ^= (wr ^ 1) << (7 - bit);
00717             \textcolor{keywordflow}{if}(c == 0)
00718                 red = dif;
00719             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(c == 1)
00720                 green = dif;
00721             \textcolor{keywordflow}{else}
00722                 blue = dif;
00723             image->setPixelColor(piece.first, QColor(red, green, blue));
00724         \}
00725     \} \textcolor{keywordflow}{else} \{
00726         \textcolor{keywordflow}{while}(left > 0)
00727         \{
00728             \textcolor{keywordflow}{while} (bitsBuffer.size() >= 8)
00729                 data->push\_back(pop(8));
00730             quint64 g = foo.generate64() % (w * h);
00731             \textcolor{keywordtype}{long} x = g % w;
00732             \textcolor{keywordtype}{long} y = g / w;
00733             \textcolor{keywordtype}{int} c = foo.generate64() % 3;
00734             \textcolor{keywordtype}{int} b = foo.generate64() % 24;
00735             \textcolor{keywordtype}{int} bit = -1;
00736             \textcolor{keywordflow}{if}(b < 16)
00737                 bit = 7;
00738             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 20)
00739                 bit = 6;
00740             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 22)
00741                 bit = 5;
00742             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 23)
00743                 bit = 4;
00744             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(bit < 24)
00745                 bit = 3;
00746             \textcolor{keyword}{auto} piece = qMakePair(QPoint(x, y), qMakePair(c, bit));
00747             \textcolor{keywordflow}{if}(were->contains(piece))
00748                 \textcolor{keywordflow}{continue};
00749             were->append(piece);
00750             left--;
00751             emit \hyperlink{class_model_p_c_afdcd80f0ed5062e145a71f09b0897547}{setProgress}(100 * (all - left) / all);
00752             QColor pixel = image->pixelColor(piece.first);
00753             \textcolor{keywordtype}{int} red = pixel.red();
00754             \textcolor{keywordtype}{int} green = pixel.green();
00755             \textcolor{keywordtype}{int} blue = pixel.blue();
00756             \textcolor{keywordtype}{int} dif;
00757             \textcolor{keywordflow}{if}(c == 0)
00758                 dif = red;
00759             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (c == 1)
00760                 dif = green;
00761             \textcolor{keywordflow}{else}
00762                 dif = blue;
00763             dif &= 1 << (7 - bit);
00764             \textcolor{keywordtype}{int} wr = dif != 0;
00765             push(wr, 1);
00766         \}
00767         \textcolor{keywordflow}{while} (bitsBuffer.size() >= 8)
00768             data->push\_back(pop(8));
00769     \}
00770 \}
00771 
\hypertarget{modelpc_8cpp_source.tex_l00778}{}\hyperlink{class_model_p_c_a4fe70ebbedfaf31d45a35f82d0f06caa}{00778} QByteArray \hyperlink{class_model_p_c_a4fe70ebbedfaf31d45a35f82d0f06caa}{ModelPC::decryptv1\_3}(QImage *image, QString key)
00779 \{
00780     \textcolor{comment}{// Image opening}
00781     \textcolor{keywordtype}{int} w = image->width();
00782     \textcolor{keywordtype}{int} h = image->height();
00783 
00784     \textcolor{comment}{// Getting corner pixels}
00785     QColor colUL = image->pixelColor(0, 0).toRgb();
00786     QColor colUR = image->pixelColor(w - 1, 0).toRgb();
00787     QColor colDR = image->pixelColor(w - 1, h - 1).toRgb();
00788 
00789 
00790     \textcolor{comment}{// Getting verification code}
00791     \textcolor{keywordtype}{int} verifCode = (((colUR.green() % 2) << 5) + colUR.blue() % 32) << 2;
00792     verifCode += colDR.blue() % 4;
00793     \textcolor{keywordflow}{if}(verifCode != 166)\{
00794         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"veriffail"});
00795         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00796     \}
00797     \textcolor{comment}{// Getting number of bytes}
00798     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} countBytes = (colUL.blue() % 32 + ((colUL.green() % 32) << 5) + ((colUL.red() % 32) << 10
      )) << 9;
00799     countBytes += ((colUR.red() % 32) << 4) + (colUR.green() >> 1) % 16;
00800 
00801     bitsUsed = (colDR.blue() >> 2) % 8 + 1;
00802     \textcolor{comment}{// curMode = colDR.green() % 32;}
00803 
00804     \textcolor{comment}{// Start of the circuit}
00805     QByteArray data;
00806     \hyperlink{class_model_p_c_a1d0091062a0c836b283ec2f67411623b}{circuit}(image, &data, countBytes);
00807 
00808     \textcolor{comment}{// Check if circuit was successful}
00809     \textcolor{keywordflow}{if}(!\hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success})
00810         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00811     \textcolor{keywordflow}{if}(data.isEmpty())
00812     \{
00813         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"noreaddata"});
00814         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00815 
00816     \}
00817     \textcolor{comment}{// Version check}
00818     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} \_ver = mod(data.at(0)) * qPow(2, 16);
00819     \_ver += mod(data.at(1)) * qPow(2, 8);
00820     \_ver += mod(data.at(2));
00821     data.remove(0, 3);
00822     \textcolor{keywordflow}{if}(\_ver > \hyperlink{class_model_p_c_a5af48ab89e19be42a94c34ba00249401}{version}) \{
00823         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"new\_version"});
00824         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00825     \}
00826     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\_ver < \hyperlink{class_model_p_c_a5af48ab89e19be42a94c34ba00249401}{version}) \{
00827         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"old\_version"});
00828         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00829     \}
00830     \textcolor{comment}{// Get the hash}
00831     QByteArray hash = data.left(32);
00832     data.remove(0, 32);
00833 
00834     \textcolor{comment}{// Unzip}
00835     QByteArray unzipped\_data = \hyperlink{class_model_p_c_a6da88f166785a49f73b22c169f956fd0}{unzip}(data, key.toUtf8());
00836     QByteArray our\_hash = QCryptographicHash::hash(unzipped\_data, QCryptographicHash::Sha256);
00837     \textcolor{keywordflow}{if}(our\_hash != hash) \{
00838         \hyperlink{class_model_p_c_a47464b59b7e37fcee25e55475708aabd}{fail}(\textcolor{stringliteral}{"veriffail"});
00839         \textcolor{keywordflow}{return} QByteArray(\textcolor{stringliteral}{""});
00840     \}
00841     \textcolor{keywordflow}{return} unzipped\_data;
00842 \}
00843 \textcolor{keywordtype}{long} ModelPC::pop(\textcolor{keywordtype}{int} bits)
00844 \{
00845     \textcolor{comment}{// Hard to say}
00846     \textcolor{keywordtype}{long} res = 0;
00847     \textcolor{keywordtype}{int} poppedBits = bits == -1 ? bitsUsed : bits;
00848     \textcolor{keywordflow}{if}(bits == -2)
00849         poppedBits = bitsBuffer.size();
00850     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < poppedBits; i++)
00851         res += bitsBuffer[i] * qPow(2, poppedBits - i - 1);
00852     bitsBuffer.remove(0, poppedBits);
00853     \textcolor{keywordflow}{return} res;
00854 \}
00855 
00856 \textcolor{keywordtype}{void} ModelPC::push(\textcolor{keywordtype}{int} data, \textcolor{keywordtype}{int} bits)
00857 \{
00858     \textcolor{comment}{// That's easier, but also hard}
00859     \textcolor{keywordtype}{int} buf\_size = bitsBuffer.size();
00860     \textcolor{keywordtype}{int} extraSize = bits == -1 ? bitsUsed : bits;
00861     bitsBuffer.resize(buf\_size + extraSize);
00862     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = bitsBuffer.size() - 1; i >= buf\_size; i--, data >>= 1)
00863         bitsBuffer[i] = data % 2;
00864 \}
00865 
00866 \textcolor{keywordtype}{bool} ModelPC::mustGoOn(\textcolor{keywordtype}{bool} isEncrypt)
00867 \{
00868     \textcolor{keywordflow}{return} \hyperlink{class_model_p_c_a945ffbbc44a832b953c191debd448f4c}{success} && (isEncrypt ? (circuitCountBytes - cur) * 8 + bitsBuffer.size() >= bitsUsed * 3
       :
00869                                    circuitData->size() * 8 + bitsBuffer.size() <
00870                                    circuitCountBytes * 8 - (circuitCountBytes * 8)% (bitsUsed * 3));
00871 \}
\hypertarget{modelpc_8cpp_source.tex_l00880}{}\hyperlink{class_model_p_c_a6da88f166785a49f73b22c169f956fd0}{00880} QByteArray \hyperlink{class_model_p_c_a6da88f166785a49f73b22c169f956fd0}{ModelPC::unzip}(QByteArray data, QByteArray key)
00881 \{
00882     \textcolor{comment}{// Decryption}
00883     QByteArray hashKey = QCryptographicHash::hash(key, QCryptographicHash::Sha256);
00884     \hyperlink{class_q_a_e_s_encryption}{QAESEncryption} encryption(\hyperlink{class_q_a_e_s_encryption_abe48208f4f6c7d68e6a10b49b9d0b7bdacde97774ab1d4c609e04b0dd13a1e1f7}{QAESEncryption::AES\_256}, 
      \hyperlink{class_q_a_e_s_encryption_ad3e031c49a3d56566379d75b40b7b255a4ca7f51778e2adf1f464164a0ba8e75e}{QAESEncryption::ECB});
00885     QByteArray new\_data = encryption.\hyperlink{class_q_a_e_s_encryption_a58f972f2b66c2454edd5112495463bba}{decode}(data, hashKey);
00886     \textcolor{comment}{// Decompressing}
00887     \textcolor{keywordflow}{return} qUncompress(new\_data);
00888 \}
\hypertarget{modelpc_8cpp_source.tex_l00897}{}\hyperlink{class_model_p_c_afebbbfa4b07deba4f68fc6dfb50f353f}{00897} QByteArray \hyperlink{class_model_p_c_afebbbfa4b07deba4f68fc6dfb50f353f}{ModelPC::zip}(QByteArray data, QByteArray key)
00898 \{
00899     \textcolor{comment}{// Zip}
00900     QByteArray c\_data = qCompress(data, 9);
00901     \textcolor{comment}{// Encryption}
00902     QByteArray hashKey = QCryptographicHash::hash(key, QCryptographicHash::Sha256);
00903     \textcolor{keywordflow}{return} \hyperlink{class_q_a_e_s_encryption_a43819eeb6a7cb29fbd3cb6ad640dcbdf}{QAESEncryption::Crypt}(\hyperlink{class_q_a_e_s_encryption_abe48208f4f6c7d68e6a10b49b9d0b7bdacde97774ab1d4c609e04b0dd13a1e1f7}{QAESEncryption::AES\_256}, 
      \hyperlink{class_q_a_e_s_encryption_ad3e031c49a3d56566379d75b40b7b255a4ca7f51778e2adf1f464164a0ba8e75e}{QAESEncryption::ECB}, c\_data, hashKey);
00904 \}
00905 
00906 \textcolor{keywordtype}{bool} ModelPC::fileExists(QString path)
00907 \{
00908     QFileInfo check\_file(path);
00909     \textcolor{keywordflow}{return} check\_file.exists() && check\_file.isFile();
00910 \}
00911 
00918 QByteArray ModelPC::bytes(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long} n)
00919 \{
00920     \textcolor{keywordflow}{return} QByteArray::fromHex(QByteArray::number(n, 16));
00921 \}
00928 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} ModelPC::mod(\textcolor{keywordtype}{int} input)
00929 \{
00930     \textcolor{keywordflow}{if}(input < 0)
00931         \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}) (256 + input);
00932     \textcolor{keywordflow}{else}
00933         \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}) input;
00934 \}
\hypertarget{modelpc_8cpp_source.tex_l00941}{}\hyperlink{class_model_p_c_a9079a101d83672aa48fd2dbac797de40}{00941} \textcolor{keywordtype}{void} \hyperlink{class_model_p_c_a9079a101d83672aa48fd2dbac797de40}{ModelPC::alert}(QString message, \textcolor{keywordtype}{bool} isWarning)
00942 \{
00943     emit \hyperlink{class_model_p_c_af0217a7ca5671e26090dc50a5dccdaf5}{alertView}(message, isWarning);
00944 \}
00950 QColor ModelPC::RGBbytes(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long} byte)
00951 \{
00952     \textcolor{keywordtype}{int} blue = byte % 256;
00953     \textcolor{keywordtype}{int} green = (byte / 256) % 256;
00954     \textcolor{keywordtype}{int} red = byte / qPow(2, 16);
00955     \textcolor{keywordflow}{return} QColor(red, green, blue);
00956 \}
00957 
00958 QString ModelPC::generateVersionString(\textcolor{keywordtype}{long} ver)
00959 \{
00960     \textcolor{keywordflow}{return} QString::number((\textcolor{keywordtype}{int})( ver / qPow(2, 16))) + \textcolor{stringliteral}{"."} + QString::number(((\textcolor{keywordtype}{int}) (ver / 256)) % 256) + \textcolor{stringliteral}{
      "."} + QString::number(ver % 256);
00961 \}
00962 
00963 uint ModelPC::randSeed()
00964 \{
00965     QTime time = QTime::currentTime();
00966     uint randSeed = time.msecsSinceStartOfDay() % 55363 + time.minute() * 21 + time.second() * 2 + 239;
00967     qsrand(randSeed);
00968     uint randSeed\_2 = qrand() % 72341 + qrand() % 3 + qrand() % 2 + 566;
00969     \textcolor{keywordflow}{return} randSeed\_2;
00970 \}
00971 QByteArray ModelPC::GetRandomBytes(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long} count)
00972 \{
00973     QByteArray res;
00974     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < count; i++)
00975        res.append(qrand() % 256);
00976     \textcolor{keywordflow}{return} res;
00977 \}
\end{DoxyCode}
